# ðŸ”§ SwinIRæ¨¡åž‹é—®é¢˜æŽ’æŸ¥æŒ‡å—

## é—®é¢˜æè¿°
ç”¨æˆ·é‡åˆ°äº†SwinIRæ¨¡åž‹è¿è¡Œæ—¶çš„Sliceæ“ä½œé”™è¯¯ï¼š
```
[WebGPU] Kernel "[Slice] Slice_264" failed. 
Error: cannot get valid size from specified dimension range. 
Most likely the range contains negative values in them.
```

## ðŸ” é—®é¢˜æ ¹å› åˆ†æž

### 1. Sliceæ“ä½œå¤±è´¥åŽŸå› 
- **ç»´åº¦è®¡ç®—é”™è¯¯**: Sliceæ“ä½œä¸­çš„ç»´åº¦èŒƒå›´åŒ…å«è´Ÿå€¼
- **è¾“å…¥å°ºå¯¸ä¸åŒ¹é…**: æ¨¡åž‹æœŸæœ›çš„è¾“å…¥ä¸Žå®žé™…æä¾›çš„ä¸ç¬¦
- **å¼ é‡å½¢çŠ¶é—®é¢˜**: NCHWæ ¼å¼ä¸æ­£ç¡®æˆ–ç»´åº¦è®¡ç®—æœ‰è¯¯

### 2. SwinIRæ¨¡åž‹ç‰¹æ®Šè¦æ±‚
- **è¾“å…¥å°ºå¯¸çº¦æŸ**: å¾ˆå¤šæ·±åº¦å­¦ä¹ æ¨¡åž‹è¦æ±‚è¾“å…¥æ˜¯8æˆ–16çš„å€æ•°
- **çª—å£åˆ†å‰²**: SwinIRä½¿ç”¨æ»‘åŠ¨çª—å£ï¼Œå¯¹è¾“å…¥å°ºå¯¸æœ‰ç‰¹å®šè¦æ±‚
- **å†…å­˜å¯¹é½**: WebGPUå¯¹å¼ é‡å†…å­˜å¸ƒå±€è¦æ±‚æ›´ä¸¥æ ¼

## âš¡ è§£å†³æ–¹æ¡ˆ

### 1. è¾“å…¥å°ºå¯¸ä¼˜åŒ–
```typescript
// ç¡®ä¿è¾“å…¥å°ºå¯¸æ˜¯8çš„å€æ•°
if (isSwinIR) {
  inputSize = Math.max(64, Math.round(inputSize / 8) * 8)
  console.log(`SwinIRæ¨¡åž‹ - è°ƒæ•´è¾“å…¥å°ºå¯¸ä¸º: ${inputSize}x${inputSize}`)
}
```

### 2. å¢žå¼ºçš„å¼ é‡éªŒè¯
```typescript
// éªŒè¯å¼ é‡æ•°æ®èŒƒå›´
if (rgbData.some(val => !isFinite(val) || val < 0 || val > 1)) {
  throw new Error('å¼ é‡æ•°æ®åŒ…å«æ— æ•ˆå€¼')
}

// éªŒè¯å¼ é‡å½¢çŠ¶
if (inputTensor.dims.some(dim => dim <= 0)) {
  throw new Error(`æ— æ•ˆçš„å¼ é‡å½¢çŠ¶: [${inputTensor.dims.join(', ')}]`)
}
```

### 3. SwinIRä¸“ç”¨é¢„å¤„ç†
```typescript
if (isSwinIR) {
  // è½»å¾®å¯¹æ¯”åº¦å¢žå¼ºï¼Œé¿å…çº¯é»‘åƒç´ å¯¼è‡´çš„ç»´åº¦é—®é¢˜
  r = Math.min(1.0, Math.max(0.0, r * 1.02))
  g = Math.min(1.0, Math.max(0.0, g * 1.02))
  b = Math.min(1.0, Math.max(0.0, b * 1.02))
}
```

### 4. é”™è¯¯é™çº§æœºåˆ¶
```typescript
// WebGPUå¤±è´¥ â†’ WebGLé™çº§ â†’ WASMé™çº§
try {
  // WebGPUæŽ¨ç†
  results = await this.session!.run(feeds)
} catch (error) {
  if (currentProvider === 'webgpu') {
    console.log('ðŸ”„ WebGPUå¤±è´¥ï¼Œå°è¯•é™çº§åˆ°WebGL...')
    return await this.fallbackToWebGL(feeds)
  }
  // ... æ›´å¤šé™çº§é€»è¾‘
}
```

## ðŸ“Š ä¿®å¤å‰åŽå¯¹æ¯”

### ä¿®å¤å‰é—®é¢˜
- âŒ å›ºå®š64x64è¾“å…¥å¯èƒ½ä¸æ»¡è¶³SwinIRè¦æ±‚
- âŒ ç¼ºä¹å¼ é‡æ•°æ®éªŒè¯
- âŒ WebGPUå¤±è´¥æ—¶æ— é™çº§æœºåˆ¶
- âŒ é¢„å¤„ç†æœªé’ˆå¯¹SwinIRä¼˜åŒ–

### ä¿®å¤åŽæ”¹è¿›
- âœ… è‡ªé€‚åº”è¾“å…¥å°ºå¯¸è°ƒæ•´ï¼ˆç¡®ä¿æ˜¯8çš„å€æ•°ï¼‰
- âœ… å®Œæ•´çš„å¼ é‡éªŒè¯å’Œé”™è¯¯æ£€æŸ¥
- âœ… æ™ºèƒ½æ‰§è¡ŒåŽç«¯é™çº§ç­–ç•¥
- âœ… SwinIRä¸“ç”¨é¢„å¤„ç†ä¼˜åŒ–
- âœ… è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—è¾“å‡º

## ðŸ› ï¸ æ•…éšœæŽ’é™¤æ­¥éª¤

### 1. æ£€æŸ¥è¾“å…¥å¼ é‡
```javascript
// åœ¨æŽ§åˆ¶å°æŸ¥çœ‹å¼ é‡ä¿¡æ¯
console.log('è¾“å…¥å¼ é‡å½¢çŠ¶:', inputTensor.dims)
console.log('æ•°æ®èŒƒå›´:', [Math.min(...rgbData), Math.max(...rgbData)])
```

### 2. ç›‘æŽ§æ‰§è¡ŒåŽç«¯
```javascript
// æŸ¥çœ‹å½“å‰ä½¿ç”¨çš„æ‰§è¡ŒåŽç«¯
console.log('æ‰§è¡ŒåŽç«¯:', modelInfo.executionProviders[0])
```

### 3. æŸ¥çœ‹é™çº§è¿‡ç¨‹
```javascript
// è§‚å¯Ÿé™çº§æ—¥å¿—
// ðŸ”„ WebGPUå¤±è´¥ï¼Œå°è¯•é™çº§åˆ°WebGL...
// ðŸ”§ WebGLé™çº§ä¼šè¯åˆ›å»ºæˆåŠŸ
```

## ðŸŽ¯ é¢„æœŸæ•ˆæžœ

ä¿®å¤åŽä½ åº”è¯¥çœ‹åˆ°ï¼š

1. **æˆåŠŸçš„è¾“å…¥é¢„å¤„ç†**:
   ```
   ðŸ”§ SwinIRæ¨¡åž‹ - è°ƒæ•´è¾“å…¥å°ºå¯¸ä¸º: 128x128
   ðŸ“Š è¾“å…¥å¼ é‡å½¢çŠ¶: [1, 3, 128, 128], æ•°æ®èŒƒå›´: [0.000, 1.020]
   ```

2. **é¡ºåˆ©çš„æŽ¨ç†æ‰§è¡Œ**:
   ```
   ðŸš€ å¼€å§‹AIæŽ¨ç† (webgpu)...
   âœ… AIæŽ¨ç†æˆåŠŸ (webgpu)ï¼Œè€—æ—¶: 1245.67ms
   ```

3. **æˆ–è€…æˆåŠŸçš„é™çº§**:
   ```
   âŒ webgpu æŽ¨ç†å¤±è´¥: Slice_264 error
   ðŸ”„ WebGPUå¤±è´¥ï¼Œå°è¯•é™çº§åˆ°WebGL...
   ðŸ”§ WebGLé™çº§ä¼šè¯åˆ›å»ºæˆåŠŸ
   âœ… AIæŽ¨ç†æˆåŠŸ (webgl)ï¼Œè€—æ—¶: 2341.23ms
   ```

## ðŸ’¡ é¢å¤–å»ºè®®

### 1. æµè§ˆå™¨å…¼å®¹æ€§
- **Chrome 94+**: æœ€ä½³WebGPUæ”¯æŒ
- **Firefox 110+**: è‰¯å¥½çš„WebGLæ”¯æŒ
- **Safari 16.4+**: åŸºç¡€WebGPUæ”¯æŒ

### 2. æ¨¡åž‹æ–‡ä»¶æ£€æŸ¥
ç¡®ä¿SwinIRæ¨¡åž‹æ–‡ä»¶å®Œæ•´ï¼š
```bash
# æ£€æŸ¥æ¨¡åž‹æ–‡ä»¶å¤§å°
ls -lh public/models/003_realSR_BSRGAN_DFO_s64w8_SwinIR-M_x4_GAN.onnx
```

### 3. æ€§èƒ½ç›‘æŽ§
- ç›‘æŽ§å†…å­˜ä½¿ç”¨ï¼š`performance.memory`
- è§‚å¯ŸGPUåˆ©ç”¨çŽ‡ï¼šå¼€å‘è€…å·¥å…· â†’ æ€§èƒ½
- æ£€æŸ¥æŽ§åˆ¶å°é”™è¯¯ï¼šF12 â†’ Console

çŽ°åœ¨SwinIRåº”è¯¥èƒ½ç¨³å®šè¿è¡Œäº†ï¼ðŸŽ‰

